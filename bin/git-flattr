#!/usr/bin/env ruby
$:.push File.expand_path("../../lib", __FILE__)

require 'git-flattr'
require 'commander/import'

program :name, "git flattr"
program :description, "Easily flattr GitHub repositories from the CLI"
program :version, VERSION
program :help, 'Author', 'Simon Gate <simon@smgt.me>'
default_command :help

Flattr.configure do |config|
  config.access_token = Git.config 'flattr.token'
end

command :repo do |c|
  c.syntax = "git flattr repo"
  c.description = "Flattr the repository"
  c.action do |args, options|
    begin

      Git.valid?

      if !Auth.is_authed?
        Auth.do!
      end

      flattr = Flattr.new
      flattr.flattr Git.github_url
      thing = flattr.thing_lookup Git.github_url
      puts "Flattred #{Git.github_url} (#{thing.link})!"
      exit 0

    rescue Flattr::Error::Unauthorized => e
      error e.message
      exit 1
    rescue Flattr::Error::Forbidden => e
      error e.message
      exit 1
    end
  end
end

command :commit do |c|
  c.syntax = "git flattr commit [commit]"
  c.description = "Flattr a commit"
  c.action do |args, opts|
    begin
      Git.valid?

      if !Auth.is_authed?
        Auth.do!
      end

      ARGV.shift
    end
  end
end
